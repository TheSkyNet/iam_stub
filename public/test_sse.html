<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IAMLab SSE Test</title>
    <link rel="stylesheet" href="/css/app.css" />
</head>
<body class="min-h-screen bg-base-200">
    <div class="toast toast-top toast-center"></div>
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-4">Serverâ€‘Sent Events (SSE) Test</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">Clock Stream</h2>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Count</span>
                        </label>
                        <input id="count" type="number" class="input input-bordered" value="5" />
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Interval (ms)</span>
                        </label>
                        <input id="interval" type="number" class="input input-bordered" value="1000" />
                    </div>
                    <div class="card-actions justify-end mt-4">
                        <button id="startClock" class="btn btn-primary">Start Clock</button>
                        <button id="stopClock" class="btn">Stop</button>
                    </div>
                    <pre id="clockLog" class="mt-4 p-3 bg-base-200 rounded h-48 overflow-auto"></pre>
                </div>
            </div>

            <div class="card bg-base-100 shadow">
                <div class="card-body">
                    <h2 class="card-title">Echo</h2>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Message</span>
                        </label>
                        <input id="message" type="text" class="input input-bordered" value="Hello from SSE!" />
                    </div>
                    <div class="card-actions justify-end mt-4">
                        <button id="sendEcho" class="btn btn-secondary">Send Echo</button>
                    </div>
                    <pre id="echoLog" class="mt-4 p-3 bg-base-200 rounded h-48 overflow-auto"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        const clockLog = document.getElementById('clockLog');
        const echoLog = document.getElementById('echoLog');
        let clockConn = null;

        function log(el, msg) {
            const time = new Date().toLocaleTimeString();
            el.textContent += `[${time}] ${msg}\n`;
            el.scrollTop = el.scrollHeight;
        }

        document.getElementById('startClock').addEventListener('click', () => {
            const count = parseInt(document.getElementById('count').value || '5', 10);
            const interval = parseInt(document.getElementById('interval').value || '1000', 10);
            if (clockConn) { clockConn.close(); clockConn = null; }
            clockLog.textContent = '';
            clockConn = window.SseService.clock({ count, interval });
            clockConn.onOpen = () => log(clockLog, 'Clock opened');
            clockConn.onError = () => log(clockLog, 'Clock error');
            clockConn.listen('tick', (e) => {
                try {
                    const data = JSON.parse(e.data);
                    log(clockLog, `tick #${data.index} time=${data.time}`);
                } catch (_) {
                    log(clockLog, `tick raw: ${e.data}`);
                }
            });
        });

        document.getElementById('stopClock').addEventListener('click', () => {
            if (clockConn) { clockConn.close(); clockConn = null; log(clockLog, 'Clock closed'); }
        });

        document.getElementById('sendEcho').addEventListener('click', () => {
            const message = document.getElementById('message').value || 'Hello from SSE!';
            const conn = window.SseService.echo(message);
            echoLog.textContent = '';
            conn.onOpen = () => log(echoLog, 'Echo opened');
            conn.onError = () => log(echoLog, 'Echo error');
            conn.listen('echo', (e) => {
                try {
                    const data = JSON.parse(e.data);
                    log(echoLog, `echo: ${data.message} at ${data.time}`);
                } catch (_) {
                    log(echoLog, `echo raw: ${e.data}`);
                }
                conn.close();
            });
        });
    </script>
</body>
</html>
